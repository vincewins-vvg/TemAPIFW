#-------------------------------------------------------------
#- Docker compose base definition file to run containers.
#-----------------------------------------------------------

version: '3.6'
services:
  cache-service:
    build:
      context: ${CACHE_CONTEXT}
      dockerfile: Dockerfile
      args:
        CACHE_BASE_IMAGE: ${CACHE_BASE_IMAGE}
    image: ${CACHE_BASE_IMAGE}
    ports:
      - "10800:10800"
  db-service:
    build:
      context: ${DB_CONTEXT}
      dockerfile: Dockerfile
      args:
        DB_BASE_IMAGE: ${DB_BASE_IMAGE}
    image: ${DB_IMAGE}
    shm_size: '1gb'
    ports:
      - "9047:9042" 
    environment:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
  
  api:
    build:
      context: ${API_CONTEXT}
      dockerfile: Dockerfile
      args:
        API_BASE_IMAGE: ${API_BASE_IMAGE}
        api_artifactid: ${api_artifactid}
        api_java_options: ${java_options} ${REMOTE_DEBUG}
    image: ${API_IMAGE}
    depends_on:
      - db-service
    ports:
      - "8090:8080"
      - "40509:40500"
    environment:
      DATABASE_KEY: cassandra
      CASSANDRA_HOST: db-service
      CASSANDRA_PORT: 9042
      CASSANDRA_USER: cassandra
      CASSANDRA_PASS:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
      CASSANDRA_SSL: 
      CASSANDRA_KEYSTORE_FILE_PATH:
      CASSANDRA_KEYSTORE_PASSWORD: 
      className_CreateNewPaymentOrder: com.temenos.microservice.payments.function.CreateNewPaymentOrderImpl
      className_GetPaymentOrders: com.temenos.microservice.payments.function.GetPaymentOrdersImpl
      className_UpdatePaymentOrder: com.temenos.microservice.payments.function.UpdatePaymentOrderImpl
      className_GetPaymentOrder: com.temenos.microservice.payments.function.GetPaymentOrderImpl
      className_invokePaymentState: com.temenos.microservice.payments.function.InvokePaymentOrderImpl
      temn.msf.name: PaymentOrder
      temn.msf.security.authz.enabled: "false"
      temn.msf.stream.vendor: kafka
      temn.msf.stream.kafka.bootstrap.servers: kafka:29092
      class.inbox.dao: com.temenos.microservice.framework.core.inbox.InboxDaoImpl
      class.outbox.dao: com.temenos.microservice.framework.core.outbox.OutboxDaoImpl
  ingester:
    build:
      context: ${INGESTER_CONTEXT}
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: ${INGESTER_APP_BASE_IMAGE}
        artifactid: ${ingester_artifactid}
        java_options: ${java_options} ${REMOTE_DEBUG}
    image: ${INGESTER_IMAGE}
    depends_on:
      - db-service
    ports:
      - "40508:40500"
    environment:
      DATABASE_KEY: cassandra
      CASSANDRA_HOST: db-service
      CASSANDRA_PORT: 9042
      CASSANDRA_USER: cassandra
      CASSANDRA_PASS:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
      CASSANDRA_SSL: 
      CASSANDRA_KEYSTORE_FILE_PATH:
      CASSANDRA_KEYSTORE_PASSWORD: 
      temn.msf.name: PaymentOrder
      temn.msf.stream.vendor: kafka
      temn.msf.schema.registry.url: http://schema-registry:8081
      temn.msf.stream.kafka.bootstrap.servers: kafka:29092
      temn.msf.ingest.source.stream: table-update-paymentorder
      temn.msf.ingest.source.stream.consumergroup.id: msf-paymentorder-ingester-consumer
      temn.msf.ingest.sink.error.stream: error-paymentorder
      temn.msf.ingest.sink.error.stream.producer.id: msf-paymentorder-ingester-error-producer
      temn.msf.ingest.event.ingester: com.temenos.microservice.framework.core.ingester.MicroserviceIngester
      com.temenos.des.event.table.payment_order.PAYMENT_ORDEREvent: com.temenos.microservice.payments.ingester.PaymentorderIngesterUpdater
      temn.msf.security.authz.enabled: "false"
      class.inbox.dao: com.temenos.microservice.framework.core.inbox.InboxDaoImpl
      class.outbox.dao: com.temenos.microservice.framework.core.outbox.OutboxDaoImpl
      PAYMENT_ORDEREvent: com.temenos.microservice.payments.entity.PaymentOrder
      temn.config.file.path: mapping/
      temn.msf.ingest.consumer.max.poll.records: "1"
      temn.ingester.mapping.enabled: "true"
      EXECUTION_ENVIRONMENT: "TEST"
  ingesterbinary:
    build:
      context: ${INGESTER_CONTEXT}
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: ${INGESTER_APP_BASE_IMAGE}
        artifactid: ${ingester_artifactid}
        java_options: ${java_options} ${REMOTE_DEBUG}
    image: ${INGESTER_IMAGE}
    depends_on:
      - db-service
    ports:
      - "40510:40500"
    environment:
      DATABASE_KEY: cassandra
      CASSANDRA_HOST: db-service
      CASSANDRA_PORT: 9042
      CASSANDRA_USER: cassandra
      CASSANDRA_PASS:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
      CASSANDRA_SSL: 
      CASSANDRA_KEYSTORE_FILE_PATH:
      CASSANDRA_KEYSTORE_PASSWORD: 
      temn.msf.name: PaymentOrder
      temn.msf.stream.vendor: kafka
      temn.msf.stream.kafka.bootstrap.servers: kafka:29092
      temn.msf.ingest.source.stream: ms-paymentorder-inbox-topic
      temn.msf.ingest.source.stream.consumergroup.id: ms-paymentorder-ingester-consumer
      temn.msf.ingest.sink.error.stream: ms-paymentorder-inbox-error-topic
      temn.msf.ingest.sink.error.stream.producer.id: ms-paymentorder-ingester-error-producer
      temn.msf.ingest.generic.ingester: com.temenos.microservice.framework.core.ingester.GenericCommandBinaryIngester
      temn.msf.exec.env: server
      temn.msf.function.class.CreateNewPaymentOrder: com.temenos.microservice.payments.function.CreateNewPaymentOrderImpl
      class.package.name: com.temenos.microservice.payments.function
      class.inbox.dao: com.temenos.microservice.framework.core.inbox.InboxDaoImpl
      class.outbox.dao: com.temenos.microservice.framework.core.outbox.OutboxDaoImpl
      temn.msf.ingest.is.avro.event.ingester: "false"
      temn.msf.security.authz.enabled: "false"
      temn.msf.ingest.inbox.cache.namespace: paymentorder-inbox
      temn.msf.ingest.outbox.cache.namespace: paymentorder-outbox
      tmn.ignite.host: cache-service
      tmn.ignite.port: 10800      
  stateingester:
    build:
      context: ${INGESTER_CONTEXT}
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: ${INGESTER_APP_BASE_IMAGE}
        artifactid: ${ingester_artifactid}
        java_options: ${java_options} ${REMOTE_DEBUG}
    image: ${INGESTER_IMAGE}
    depends_on:
      - db-service
    ports:
      - "40511:40501"
    environment:
      DATABASE_KEY: cassandra
      CASSANDRA_HOST: db-service
      CASSANDRA_PORT: 9042
      CASSANDRA_USER: cassandra
      CASSANDRA_PASS:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
      CASSANDRA_SSL: 
      CASSANDRA_KEYSTORE_FILE_PATH:
      CASSANDRA_KEYSTORE_PASSWORD:
      temn.msf.name: PaymentOrder
      temn.msf.stream.vendor: kafka
      temn.msf.schema.registry.url: http://schema-registry:8081
      temn.msf.stream.kafka.bootstrap.servers: kafka:29092
      temn.msf.ingest.source.stream: table-update-state
      temn.msf.ingest.source.stream.consumergroup.id: msf-paymentorder-ingester-consumer
      temn.msf.ingest.sink.error.stream: error-paymentorder
      temn.msf.ingest.sink.error.stream.producer.id: msf-paymentorder-ingester-error-producer
      temn.msf.security.authz.enabled: "false"
      temn.ingester.business.group.id: msf-test-group-id
      temn.ingester.business.topic: table-update-business
      temn.msf.ingest.generic.ingester:  com.temenos.microservice.payments.ingester.PaymentOrderStateIngester
      temn.msf.ingest.is.avro.event.ingester: "false"
      temn.iris.fdata.enquiry.base.path: http://10.93.23.52:9089/irf-provider-container/api/v1.0.0/
      temn.iris.fdata.enquiry.resource.path: system/metrics/dataEvents/pendings/itemCount
      temn.msf.security.authz.enabled: "false"
      class.inbox.dao: com.temenos.microservice.framework.core.inbox.InboxDaoImpl
      class.outbox.dao: com.temenos.microservice.framework.core.outbox.OutboxDaoImpl
      EXECUTION_ENVIRONMENT: TEST
  businessingester:
    build:
      context: ${INGESTER_CONTEXT}
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: ${INGESTER_APP_BASE_IMAGE}
        artifactid: ${ingester_artifactid}
        java_options: ${java_options} ${REMOTE_DEBUG}
    image: ${INGESTER_IMAGE}
    depends_on:
      - db-service
    ports:
      - "40512:40500"
    environment:
      DATABASE_KEY: cassandra
      CASSANDRA_HOST: db-service
      CASSANDRA_PORT: 9042
      CASSANDRA_USER: cassandra
      CASSANDRA_PASS:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
      CASSANDRA_SSL: 
      CASSANDRA_KEYSTORE_FILE_PATH:
      CASSANDRA_KEYSTORE_PASSWORD:
      temn.msf.name: PaymentOrder
      temn.msf.stream.vendor: kafka
      temn.msf.schema.registry.url: http://schema-registry:8081
      temn.msf.stream.kafka.bootstrap.servers: kafka:29092
      temn.msf.ingest.source.stream: table-update-business
      temn.msf.ingest.source.stream.consumergroup.id: msf-test-group-id
      temn.msf.ingest.sink.error.stream: error-paymentorder
      temn.msf.ingest.sink.error.stream.producer.id: msf-paymentorder-ingester-error-producer
      temn.msf.ingest.generic.ingester:  com.temenos.microservice.payments.ingester.PaymentOrderBusinessIngester
      temn.msf.stream.outbox.topic: paymentorder-event-topic
      temn.msf.security.authz.enabled: "false"
      temn.msf.ingest.is.avro.event.ingester: "false"
      class.inbox.dao: com.temenos.microservice.framework.core.inbox.InboxDaoImpl
      class.outbox.dao: com.temenos.microservice.framework.core.outbox.OutboxDaoImpl
      temn.msf.security.authz.enabled: "false"
      temn.msf.ingest.consumer.max.poll.records: "1"
      DATABASE_KEY: sql

  configBinaryIngester:
    build:
      context: ${INGESTER_CONTEXT}
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: ${INGESTER_APP_BASE_IMAGE}
        artifactid: ${ingester_artifactid}
        java_options: ${java_options} ${REMOTE_DEBUG}
    image: ${INGESTER_IMAGE}
    depends_on:
      - db-service
    ports:
      - "40513:40500"
    environment:
      DATABASE_KEY: cassandra
      CASSANDRA_HOST: db-service
      CASSANDRA_PORT: 9042
      CASSANDRA_USER: cassandra
      CASSANDRA_PASS:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
      CASSANDRA_SSL: 
      CASSANDRA_KEYSTORE_FILE_PATH:
      CASSANDRA_KEYSTORE_PASSWORD:
      temn.msf.name: PaymentOrder
      temn.msf.stream.vendor: kafka
      temn.msf.schema.registry.url: http://schema-registry:8081
      temn.msf.stream.kafka.bootstrap.servers: kafka:29092
      temn.msf.ingest.source.stream: table-update-binary
      temn.msf.ingest.source.stream.consumergroup.id: msf-test-group-id
      temn.msf.ingest.sink.error.stream: error-paymentorder
      temn.msf.ingest.sink.error.stream.producer.id: msf-paymentorder-ingester-error-producer
      temn.msf.ingest.generic.ingester: com.temenos.microservice.framework.core.ingester.ConfigBasedBinaryIngestionFunctionImpl
      temn.msf.security.authz.enabled: "false"
      temn.msf.ingest.is.avro.event.ingester: "false"
      class.inbox.dao: com.temenos.microservice.framework.core.inbox.InboxDaoImpl
      class.outbox.dao: com.temenos.microservice.framework.core.outbox.OutboxDaoImpl
      temn.msf.security.authz.enabled: "false"
      PAYMENT_ORDEREvent: com.temenos.microservice.payments.entity.PaymentOrder
      temn.config.file.path: mapping/
      EXECUTION_ENVIRONMENT: "TEST"
      
  eventingester:
    build:
      context: ${INGESTER_CONTEXT}
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: ${INGESTER_APP_BASE_IMAGE}
        artifactid: ${ingester_artifactid}
        java_options: ${java_options} ${REMOTE_DEBUG}
    image: ${INGESTER_IMAGE}
    depends_on:
      - db-service
    ports:
      - "40516:40500"
    environment:
      DATABASE_KEY: cassandra
      CASSANDRA_HOST: db-service
      CASSANDRA_PORT: 9042
      CASSANDRA_USER: cassandra
      CASSANDRA_PASS:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
      CASSANDRA_SSL: 
      CASSANDRA_KEYSTORE_FILE_PATH:
      CASSANDRA_KEYSTORE_PASSWORD: 
      temn.msf.name: PaymentOrder
      temn.msf.stream.vendor: kafka
      temn.msf.stream.kafka.bootstrap.servers: kafka:29092
      temn.msf.ingest.source.stream: paymentorder-event-topic
      temn.msf.ingest.source.stream.consumergroup.id: ms-paymentorder-ingester-consumer
      temn.msf.ingest.sink.error.enabled: "false"
      temn.msf.ingest.sink.error.stream.producer.id: ms-paymentorder-ingester-error-producer
      temn.msf.ingest.generic.ingester: com.temenos.microservice.framework.core.ingester.GenericCommandBinaryIngester
      temn.msf.exec.env: server
      temn.msf.function.class.CreateNewPaymentOrder: com.temenos.microservice.payments.function.CreateNewPaymentOrderImpl
      temn.msf.ingest.event.processor: com.temenos.microservice.payments.ingester.EventHandlerImpl
      # temn.msf.raise.received.event: "true"
      class.package.name: com.temenos.microservice.payments.function
      class.inbox.dao: com.temenos.microservice.framework.core.inbox.InboxDaoImpl
      class.outbox.dao: com.temenos.microservice.framework.core.outbox.OutboxDaoImpl
      temn.msf.ingest.is.avro.event.ingester: "false"
      temn.msf.security.authz.enabled: "false"

  inboxoutboxprocessorapp:
    build:
      context: ${INBOXOUTBOX_CONTEXT}
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: ${INBOXOUTBOX_BASE_IMAGE}
        artifactid: ${inboxoutbox_artifactid}
        java_options: ${java_options} ${REMOTE_DEBUG}
    image: ${INBOXOUTBOX_IMAGE}
    depends_on:
      - cache-service
    ports:
      - "40514:40500"
    environment:
      DATABASE_KEY: cassandra
      CASSANDRA_HOST: db-service
      CASSANDRA_PORT: 9042
      CASSANDRA_USER: cassandra
      CASSANDRA_PASS:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
      CASSANDRA_SSL: 
      CASSANDRA_KEYSTORE_FILE_PATH:
      CASSANDRA_KEYSTORE_PASSWORD: 
      temn.msf.name: PaymentOrder
      temn.msf.stream.vendor: kafka
      temn.msf.stream.kafka.bootstrap.servers: kafka:29092
      temn.msf.exec.env: server
      temn.msf.stream.outbox.topic: ms-paymentorder-outbox-topic
      temn.msf.function.class.CreateNewPaymentOrder: com.temenos.microservice.payments.function.CreateNewPaymentOrderImpl
      class.package.name: com.temenos.microservice.payments.function
      class.inbox.dao: com.temenos.microservice.framework.core.inbox.InboxDaoImpl
      class.outbox.dao: com.temenos.microservice.framework.core.outbox.OutboxDaoImpl
      temn.msf.security.authz.enabled: "false"
      tmn.inbox.source.namespace: paymentorder-inbox
      tmn.outbox.source.namespace: paymentorder-outbox
      temn.msf.ingest.outbox.cache.namespace: paymentorder-outbox
      tmn.ignite.host: cache-service
      tmn.ignite.port: 10800
      tmn.inbox.thread.pool.count: 10
      tmn.outbox.thread.pool.count: 10
      
  catchupprocessorapp:
    build:
      context: ${CATCHUPPROCESSOR_CONTEXT}
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: ${CATCHUPPROCESSOR_BASE_IMAGE}
        artifactid: ${catchupprocessor_artifactid}
        java_options: ${java_options} ${REMOTE_DEBUG}
    image: ${CATCHUPPROCESSOR_IMAGE}
    ports:
      - "40515:40500"
    environment:
      DATABASE_KEY: cassandra
      CASSANDRA_HOST: db-service
      CASSANDRA_PORT: 9042
      CASSANDRA_USER: cassandra
      CASSANDRA_PASS:
      CASSANDRA_KEYSPACE: ${DB_KEYSPACE}
      CASSANDRA_SSL: 
      CASSANDRA_KEYSTORE_FILE_PATH:
      CASSANDRA_KEYSTORE_PASSWORD: 
      temn.msf.name: PaymentOrder
      temn.msf.security.authz.enabled: "false"
      tmn.inbox.source.namespace: paymentorder-inbox
      tmn.outbox.source.namespace: paymentorder-outbox
      tmn.ignite.host: cache-service
      tmn.ignite.port: 10800
      tem.msf.timeDelay: 2
      tem.msf.inboxSchedulerTime: 0/30 * * * * ?
      tem.msf.outboxSchedulerTime: 0/30 * * * * ?